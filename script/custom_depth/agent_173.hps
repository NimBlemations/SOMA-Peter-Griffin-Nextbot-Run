#include "agents/Agent_Humanoid.hps"

#include "helper/helper_audio.hps"
#include "helper/helper_effects.hps"
#include "custom_depth/helper_custom_depth.hps"
#include "helpers/helper_modules.hps"
#include "base/Base_Types.hps"

//Commas are at the end of these I guess???

enum e173State {
	e173State_Idle,
	e173State_Patrol,
	e173State_PlayerSpotted,
};

enum e173Speed {
	e173Speed_Idle,
	e173Speed_Scrape,
}

class cScrAgent173 : cScrAgentHumanoid {
	
	void Init() {
		mBaseObj.SetUpdatePlayerDetection(true);
		mBaseObj.SetCheckForDoors(true);
		mBaseObj.SetMaxCheckDoorDistance(0.65f);
	}
	
	void SetupCharBody() {
		cScrAgentHumanoid::SetupCharBody();
		
		iCharacterBody@ pCharBody = mBaseObj.GetCharBody();
		
		pCharBody.SetMass(80);
		pCharBody.SetMaxPositiveMoveSpeed(eCharDir_Forward,1.0f);
		pCharBody.SetMoveAcc(eCharDir_Forward,12);
		pCharBody.SetMoveDeacc(eCharDir_Forward,16);
		pCharBody.SetMaxPushMass(20);
		pCharBody.SetMaxPushForce(300);
		pCharBody.SetAccurateClimbing(true);
	}
	
	e173Speed ToMoveSpeed(const tString& in asSpeed) {
		if(asSpeed == "Scrape") return e173Speed_Scrape;
		
		Error("173 move speed '"+asSpeed+"' does not exist!");
		return e173Speed_Scrape;
	}
	
	void SetupAfterLoad(cWorld @apWorld, cResourceVarsObject@ apVars, cResourceVarsObject@ apInstanceVars) {
		cScrAgentHumanoid::SetupAfterLoad(apWorld, apVars, apInstanceVars);
		
		mBaseObj.SetAlignEntityWithGroundRay(true);
		mBaseObj.SetFOV(cMath_ToRad(360));
		mBaseObj.SetSightRange(300.f);
		mBaseObj.SetRelativeEyeHeight(0.8f);
		
		mPatrolSpeed = ToMoveSpeed(apInstanceVars.GetVarString("PatrolSpeed", "Scrape"));
		
		mbAttackCanBeFatal =  apInstanceVars.GetVarBool("AttackCanBeFatal", true);
		
		mpPathfinder.SetNodeContainerName("173");
		mpPathfinder.SetMaxHeight(0.8f);
		
		mpMover.SetupWallAvoidance(0.8f, 5.0f, 4);
		mpMover.SetupDynamicObjectAvoidance(1.7f, 10, 3);
		
		mpMover.SetMaxForwardSpeed(1);
		mpMover.SetMaxBackwardSpeed(1);
		
		float fScrapeMul = apInstanceVars.GetVarFloat("ScrapeSpeedMul", 1.0f);
		
		mpMover.AddSpeedState(e173Speed_Scrape);
		mpMover.SetSpeedState_Forward(0.7 * fScrapeMul);
		
		@mpStateMachine = cLux_CreateEntityComponent_StateMachine(mBaseObj);
		
		mpStateMachine.AddState("Idle", e173State_Idle);
		mpStateMachine.AddState("Patrol", e173State_Patrol);
		mpStateMachine.AddState("PlayerSpotted", e173State_PlayerSpotted);
	}
	
	void OnAfterWorldLoad() {
		cScrAgentHumanoid::OnAfterWorldLoad();
	}
	
	void OnUpdate(float afTimeStep) {
		cScrAgentHumanoid::OnUpdate(afTimeStep);
		
		bool bSeen = mBaseObj.GetEntityIsInPlayerLineOfSight(true);
		
		if (EyeTracking_IsAiReactive()) {
			if (EyeTracking_HasPlayerBlinked()) {
				bSeen = false;
			}
			else {
				bSeen = EyeTracking_IsEntityBeingLookedAt(mBaseObj.GetID());
			}
		}
		
		if (!bSeen) {
			mbSeenByPlayer = false;
		}
		else {
			mbSeenByPlayer = true;
		}
	}
}